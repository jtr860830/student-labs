<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VM 管理介面</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            padding: 30px;
            background: #f8f8f8
        }

        h2 {
            text-align: center;
            margin-bottom: 20px
        }

        table {
            width: 60%;
            min-width: 320px;
            margin: auto;
            border-collapse: collapse;
            background: #fff;
            box-shadow: 0 0 8px rgba(0, 0, 0, .1)
        }

        th,
        td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: center
        }

        th {
            background: #4CAF50;
            color: #fff
        }

        .status-running {
            color: #27ae60;
            font-weight: bold
        }

        .status-stopped {
            color: #e74c3c;
            font-weight: bold
        }

        .refresh {
            position: fixed;
            right: 30px;
            bottom: 30px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #4CAF50;
            color: #fff;
            font-size: 24px;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .3)
        }

        .create {
            background: #3498db;
            color: #fff;
            padding: 10px 16px;
            margin-bottom: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer
        }
    </style>
</head>

<body>
    <h2>我的資源管理</h2>

    <div style="width:60%;min-width:320px;margin:auto;text-align:right">
        <button class="create" onclick="window.location='/create'">＋ 建立新資源</button>
        <button class="logout" onclick="logout()"> 登出</button>

    </div>

    <table id="resourceTable">
        <thead>
            <tr>
                <th>VM 名稱</th>
                <th>狀態</th>
                <th>SSH 指令</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button class="refresh" title="重新整理" onclick="loadResources()">⟳</button>

    <script>
        const API_BASE = 'http://157.230.41.208:5002';
        const token = localStorage.getItem('token');
        if (!token) { location.href = '/login'; }

        const tbody = document.querySelector('#resourceTable tbody'); // 找到表格的 tbody 元素，用來動態插入資料列

        async function loadResources() {
            tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;">載入中...</td></tr>';
            try {
                const res = await fetch(`${API_BASE}/myvms`, {
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) { throw new Error(res.statusText); }
                const raw = await res.json();
                renderResources(raw);
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="2" style="text-align:center;color:#e74c3c;">載入失敗：${err.message}</td></tr>`;
                console.error(err);
            }
        }

        function renderResources(data) {
            // 如果不是陣列或是空陣列，就顯示「目前沒有任何資源」
            if (!Array.isArray(data) || data.length === 0) {
                tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align:center; color: #999;">
                    目前沒有任何資源
                </td>
            </tr>
        `;
                return;
            }

            // 清空表格內容
            tbody.innerHTML = '';

            // 遍歷每個 VM 資料，渲染表格
            for (const vm of data) {
                const vmName = vm.name || '未命名';
                const statusRaw = vm.status || 'unknown';
                const sshCmd = vm.ssh || '-';
                const vmid = vm.vmid;

                const status = statusRaw.toLowerCase();
                const statusClass = status === 'running'
                    ? 'status-running'
                    : (status === 'stopped' ? 'status-stopped' : '');

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${vmName}</td>
            <td class="${statusClass}">${status}</td>
            <td>${sshCmd}</td>
            <td>
                <button onclick="start(${vmid})">啟動</button>
                <button onclick="stop(${vmid})">停止</button>
                <button onclick="restart(${vmid})">重啟</button>
                <button onclick="deleteVM(${vmid})">刪除</button>
            </td>
        `;
                tbody.appendChild(row);
            }
        }



        loadResources();

        function logout() {
            localStorage.removeItem('token');
            location.href = '/login';
        }
        async function start(vmid) {
            try {
                const res = await fetch(`${API_BASE}/vm/pve/${vmid}/start`, {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!res.ok) throw new Error(res.statusText);
                loadResources(); // 重新載入 VM 狀態
            } catch (err) {
                showError(err);
            }
        }

        async function stop(vmid) {
            try {
                const res = await fetch(`${API_BASE}/vm/pve/${vmid}/stop`, {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!res.ok) throw new Error(res.statusText);
                loadResources();
            } catch (err) {
                showError(err);
            }
        }

        async function restart(vmid) {
            try {
                const res = await fetch(`${API_BASE}/vm/pve/${vmid}/restart`, {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!res.ok) throw new Error(res.statusText);
                loadResources();
            } catch (err) {
                showError(err);
            }
        }

        async function deleteVM(vmid) {
            try {
                const res = await fetch(`${API_BASE}/vm/pve/${vmid}`, {
                    method: "DELETE",
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!res.ok) throw new Error(res.statusText);
                loadResources();
            } catch (err) {
                showError(err);
            }
        }


    </script>
</body>

</html>